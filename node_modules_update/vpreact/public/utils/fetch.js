"use strict";
Object.defineProperty(exports, "__esModule", {
	value: !0
}), exports.vpUpLoad1 = exports.vpRemove1 = exports.vpEdit1 = exports.vpAdd1 = exports.vpDownLoad1 = exports.vpQuery1 = exports.loginOut1 = exports.loginIn1 = exports.fetch_time_out1 = void 0;
var _stringify = require("babel-runtime/core-js/json/stringify"),
	_stringify2 = _interopRequireDefault(_stringify),
	_keys = require("babel-runtime/core-js/object/keys"),
	_keys2 = _interopRequireDefault(_keys),
	_promisePolyfill = require("promise-polyfill"),
	_promisePolyfill2 = _interopRequireDefault(_promisePolyfill),
	_fetchIe = require("fetch-ie8"),
	_fetchIe2 = _interopRequireDefault(_fetchIe),
	_utils = require("./utils"),
	_Vp = require("../Vp"),
	_reactRouter = require("react-router");

function _interopRequireDefault(e) {
	return e && e.__esModule ? e : {
		default: e
	}
}
var show401 = !1,
	firstReciver = 0,
	firstVp = 0,
	checkStatus = function (e, t) {
		var o = {};
		switch (e) {
			case 400:
				o = {
					msg: t.msg ? t.msg : "400：Bad Request",
					state: !1
				}, show401 = !1;
				break;
			case 401:
			case 403:
				if (show401) return {
					state: !0
				};
				o = {
					msg: t.msg ? t.msg : "登录超时，请重新登录",
					state: !1
				}, show401 = !0, setTimeout(function () {
					t.redirectUrl ? window.location.href = vp.gateway.handleGateWay(t.redirectUrl) : window.location.href = vp.gateway.handleGateWay(window.vp.config.URL.localHost + "/login")
				}, 3e3);
				break;
			case 404:
				o = {
					msg: t.msg ? t.msg : "未找到对应资源，请稍后再试",
					state: !1
				}, show401 = !1;
				break;
			case 405:
				o = {
					msg: t.msg ? t.msg : "请求方式错误",
					state: !1
				}, show401 = !1;
				break;
			default:
				show401 = !(o = {
					state: !0
				})
		}
		return o
	},
	myRequest = function (e, t, o, r) {
		"form_data" == t ? t = _utils.TYPE_FORMDATA : "form" != t && null != t || (t = _utils.TYPE_FORM);
		var n = {
			Authorization: r ? "Basic " + r : "Bearer " + window.vp.cookie.getToken(),
			"Content-Type": t + ";charset=UTF-8",
			Locale: "zh" == window.LOCALE ? "zh_CN" : "en_US"
		};
		r || window.vp.cookie.getToken() || (n = {
			"Content-Type": t + ";charset=UTF-8",
			Locale: "zh" == window.LOCALE ? "zh_CN" : "en_US"
		});
		var i = {
			method: e,
			headers: n,
			body: o
		};
		return "GET" !== e && "DELETE" !== e || (i = {
			method: e || "GET",
			headers: n
		}), i
	},
	aesEncrypt = function (e) {
		var t = CryptoJS.enc.Utf8.parse(e),
			o = CryptoJS.enc.Utf8.parse("rSzSK900KLMxOgZ/");
		return CryptoJS.AES.encrypt(t, o, {
			mode: CryptoJS.mode.ECB,
			padding: CryptoJS.pad.Pkcs7
		}).toString()
	},
	rsaEncrypt = function (e) {
		var t = RSAUtils.getKeyPair("16d1507964604313b5121c52c1051115", "", "70a6c76c3631387e7eaca739f7f5cbe7");
		return RSAUtils.encryptedString(t, e)
	},
	aesDecrypt = function (e) {
		var t = CryptoJS.enc.Utf8.parse("rSzSK900KLMxOgZ/"),
			o = CryptoJS.AES.decrypt(e, t, {
				mode: CryptoJS.mode.ECB,
				padding: CryptoJS.pad.Pkcs7
			});
		return CryptoJS.enc.Utf8.stringify(o)
	},
	rsaDecrypt = function (e) {
		var t = RSAUtils.getKeyPair("16d1507964604313b5121c52c1051115", "55afdcf744d8f5fe0c655fee417b3765", "70a6c76c3631387e7eaca739f7f5cbe7");
		return RSAUtils.decryptedString(t, e)
	},
	buildParams = function (e, t, o) {
		if (!e) return "";
		var r = void 0,
			n = void 0,
			i = function (e) {
				return e
			};
		if (t && ("A" == t ? (i = aesEncrypt, n = "en1") : "B" == t && (i = rsaEncrypt, n = "en2")), o) {
			if (!(0, _keys2.default)(e).length) return "";
			r = t ? "?" + serialize(e, i) + "&vpencrypt=" + n : "?" + serialize(e, i)
		} else {
			var s = [];
			for (var c in e) {
				var a = void 0 === e[c] ? "" : e[c];
				s.push(c + "=" + i(encodeURIComponent(a)))
			}
			t && s.push("vpencrypt=" + n), r = s.join("&")
		}
		return r
	},
	serialize = function (e, t) {
		var o = [];
		for (var r in e) e.hasOwnProperty(r) && o.push(encodeURIComponent(r) + "=" + t(encodeURIComponent(e[r])));
		return o.join("&")
	},
	domain = function (e, t) {
		return t = e ? 0 <= t.indexOf("http:") || 0 <= t.indexOf("https:") ? "" + t + e : "" + _utils.API_PREFIX + t + e : 0 <= t.indexOf("http:") || 0 <= t.indexOf("https:") ? "" + t : "" + _utils.API_PREFIX + t
	},
	fetchJSON = function (e, t, o, r, n, i, s) {
		var c = 1 < arguments.length && void 0 !== t ? t : {},
			a = 2 < arguments.length && void 0 !== o ? o : "",
			p = 3 < arguments.length && void 0 !== r ? r : 6e4,
			f = 4 < arguments.length && void 0 !== n ? n : "form",
			l = 5 < arguments.length && void 0 !== i ? i : "GET",
			u = s;
		e = vp.gateway.handleGateWay(e);
		var d = "";
		"POST" === l || "PUT" === l ? c = buildParams(c, a) : "GET" === l ? e += ((0, _keys2.default)(c).length ? "?" : "") + buildParams(c, a) : "DELETE" === l && (d = buildParams(c, a, !0)), e = domain(d, e), window.Promise || (window.Promise = _promisePolyfill2.default, fetch = fetch || _fetchIe2.default);
		var g = myRequest(l, f, c, u),
			m = fetch(e, g).then(function (e) {
				if (200 <= e.status && e.status < 300) return e.json().then(function (e) {
					return firstReciver = 0, e.infocode && "VP302000" === e.infocode ? (_reactRouter.hashHistory.push({
						pathname: "/exception/registrationcode",
						state: {
							url: "/registrationcode",
							address: "Exception/RegistrationCode"
						}
					}), _promisePolyfill2.default.reject(e)) : (isVPInfoCode(e), _promisePolyfill2.default.resolve(e))
				});
				var n = e.status;
				return console.log("010", n), e.json().then(function (e) {
					var t = checkStatus(n, e),
						o = t.msg,
						r = t.state;
					return console.log("020", e), 1 == (firstReciver += 1) && show401 ? (0, _Vp.VpAlertMsg)({
						message: "错误提示",
						description: "" + o,
						type: "error",
						closeText: "关闭",
						showIcon: !0
					}, 3) : r || show401 ? 1 == firstReciver && r && !show401 && (console.log("04", e), (0, _Vp.VpAlertMsg)({
						message: "错误提示",
						description: "服务异常或网络错误...",
						type: "error",
						closeText: "关闭",
						showIcon: !0
					}, 5)) : (0, _Vp.VpAlertMsg)({
						message: "错误提示",
						description: "" + o,
						type: "error",
						closeText: "关闭",
						showIcon: !0
					}, 5), e.msg && r && !show401 && (console.log("03", e), isVPInfoCode(e)), _promisePolyfill2.default.reject(e)
				})
			}).catch(function (e) {
				if (vp.config.ajaxoptions && vp.config.ajaxoptions.setLocalStorage) {
					localStorage.setItem("catch" + e.timestamp, (0, _stringify2.default)(e)), localStorage.setItem("request" + e.timestamp, (0, _stringify2.default)(g));
					"TypeError" == e.name ? "TypeError:" + e.message : 500 == e.status && "500:" + e.statusText
				}
				return 0 != $(".vp-alert-msg-notice-content").length || show401 || (0, _Vp.VpAlertMsg)({
					message: (vp.config.ajaxoptions && vp.config.ajaxoptions.title ? vp.config.ajaxoptions.title : "服务异常") + e.infocode,
					description: React.createElement("div", {
						className: "alertdes"
					}, vp.config.ajaxoptions && vp.config.ajaxoptions.description ? vp.config.ajaxoptions.description : "服务端调用异常，请与系统管理员联系！", vp.config.ajaxoptions && vp.config.ajaxoptions.setLocalStorage ? React.createElement("p", null, errStr) : null),
					type: "error",
					closeText: "关闭",
					showIcon: !0
				}, 5), console.log("04", e), _promisePolyfill2.default.reject(e)
			});
		return fetch_time_out1(m, p)
	};

function isVPInfoCode(e) {
	switch ((e.hasOwnProperty("infocode") ? e.infocode.match(/^VP+\d{1}/) || [] : "")[0]) {
		case "VP1":
			(0, _Vp.VpAlertMsg)({
				message: "消息提示",
				description: e.infocode + "：" + e.msg,
				type: "info",
				closeText: "关闭",
				showIcon: !0
			}, 5);
			break;
		case "VP2":
			(0, _Vp.VpAlertMsg)({
				message: "警告提示",
				description: e.infocode + "：" + e.msg,
				type: "warning",
				closeText: "关闭",
				showIcon: !0
			}, 5);
			break;
		case "VP3":
			if (firstVp += 1, 0 == $(".vp-alert-msg-notice-content").length && "VP300000" === e.infocode) return void(0, _Vp.VpAlertMsg)({
				message: "错误提示" + e.infocode,
				description: vp.config.ajaxoptions && vp.config.ajaxoptions.description ? vp.config.ajaxoptions.description : "服务端调用异常，请与系统管理员联系！",
				type: "error",
				closeText: "关闭",
				showIcon: !0
			}, 5);
			0 == $(".vp-alert-msg-notice-content").length && (0, _Vp.VpAlertMsg)({
				message: "错误提示" + e.infocode,
				description: e.msg,
				type: "error",
				closeText: "关闭",
				showIcon: !0
			}, 5)
	}
}
var fetch_time_out1 = exports.fetch_time_out1 = function (e, o) {
	var t = new _promisePolyfill2.default(function (e, t) {
		setTimeout(function () {
			return t("timeout")
		}, o)
	});
	return _promisePolyfill2.default.race([e, t]).catch(function (e) {
		return "timeout" == e && (0, _Vp.ErrorPage)(vp.config.URL.errormsg && vp.config.URL.errormsg.title ? vp.config.URL.errormsg.title : "呀，网络开小差了~~", vp.config.URL.errormsg ? vp.config.URL.errormsg.content : "", e), _promisePolyfill2.default.reject(e)
	})
};

function setFetchTimeout(e) {
	var t = void 0;
	return e ? "number" == typeof e ? t = e : ((0, _Vp.VpAlertMsg)({
		message: "消息提示",
		description: "请设置正确的超时时间！",
		type: "info",
		closeText: "关闭",
		showIcon: !0
	}, 5), vp.config.URL.hasOwnProperty("timeout") && vp.config.URL.timeout && ("number" == typeof vp.config.URL.timeout ? t = vp.config.URL.timeout : (0, _Vp.VpAlertMsg)({
		message: "消息提示",
		description: "请设置正确的超时时间！",
		type: "info",
		closeText: "关闭",
		showIcon: !0
	}, 5))) : vp.config.URL.hasOwnProperty("timeout") && vp.config.URL.timeout && ("number" == typeof vp.config.URL.timeout ? t = vp.config.URL.timeout : (0, _Vp.VpAlertMsg)({
		message: "消息提示",
		description: "请设置正确的超时时间！",
		type: "info",
		closeText: "关闭",
		showIcon: !0
	}, 5)), t
}
var loginIn1 = exports.loginIn1 = function (e, t, o, r, n) {
		return fetchJSON(e, t, o, setFetchTimeout(r), "form", "POST", n)
	},
	loginOut1 = exports.loginOut1 = function (e) {
		return fetchJSON(e, {}, "", 5e3, "form", "GET")
	},
	vpQuery1 = exports.vpQuery1 = function (e, t, o, r) {
		return fetchJSON(e, t, o, setFetchTimeout(r), "form", "GET")
	},
	vpDownLoad1 = exports.vpDownLoad1 = function (e, t) {
		setTimeout(function () {
			window.location.href = vp.cookie.joinToken(vp.gateway.handleGateWay(e), t).replace("_tk=", "access_token=")
		}, 100)
	},
	vpAdd1 = exports.vpAdd1 = function (e, t, o, r) {
		return fetchJSON(e, t, o, setFetchTimeout(r), "form", "POST")
	},
	vpEdit1 = exports.vpEdit1 = function (e, t, o, r) {
		return fetchJSON(e, t, o, setFetchTimeout(r), "form", "PUT")
	},
	vpRemove1 = exports.vpRemove1 = function (e, t, o, r) {
		return fetchJSON(e, t, o, setFetchTimeout(r), "form", "DELETE")
	},
	vpUpLoad1 = exports.vpUpLoad1 = function (e, t, o, r) {
		return fetchJSON(e, t, o, r, "form_data", "POST")
	};